
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuvien Luokittelu ja Selaus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .warning-banner {
            background: #ff9800;
            color: white;
            padding: 15px;
            text-align: center;
            margin: 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .time-selection {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .time-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .time-group h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }
        input, select, button {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .classify-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        .compare-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        .timelapse-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .nav-link {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        .image-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .image-info {
            padding: 15px;
        }
        .image-info h3 {
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 16px;
        }
        .image-meta {
            font-size: 14px;
            color: #7f8c8d;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        .time-slider {
            width: 100%;
            margin: 10px 0;
        }
        .time-display {
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            color: #2c3e50;
        }
        .time-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .preset-btn {
            padding: 8px 12px;
            font-size: 14px;
        }
        .timelapse-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .timelapse-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 95%;
            max-height: 95%;
            overflow: auto;
            width: 900px;
        }
        .timelapse-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            align-items: end;
            margin: 20px 0;
        }
        .speed-control {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            grid-column: 1 / -1;
            margin-top: 10px;
        }
        .speed-control button {
            padding: 8px 5px;
            font-size: 12px;
        }
        .timelapse-image {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        .active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
        }
        /* RTSP section */
        .rtsp-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        .rtsp-section input {
            flex: 1;
        }
        .hls-video {
            width: 100%;
            max-height: 480px;
            margin-top: 15px;
            display: none;
            border-radius: 8px;
            background: #000;
        }
        /* Hierarkkisen navigoinnin tyylit */
        .breadcrumb {
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 30px;
        }
        .folder-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .folder-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .folder-icon {
            font-size: 2em;
            margin-bottom: 10px;
            color: #3498db;
        }
        .folder-count {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        /* Hierarkkisen navigoinnin kontrollit */
        .hierarchy-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        .hierarchy-controls h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        /* Image modal (lightbox) */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0,0,0,0.85);
            align-items: center;
            justify-content: center;
        }
        .image-modal-content {
            position: relative;
            margin: auto;
            max-width: 95%;
            max-height: 95%;
            background: transparent;
            padding: 20px;
            text-align: center;
            color: #fff;
        }
        .image-modal-content img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            border: 2px solid #ffffff33;
        }
        .image-modal-meta {
            margin-top: 10px;
            color: #ddd;
            font-size: 14px;
        }
        .image-modal .close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 2100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Kuvien Luokittelu ja Selaus</h1>
            <p>Selaa, vertaile ja katso timelapse-kuvia aikav√§lin mukaan</p>
        </div>

        {% if not classification_available %}
        <div class="warning-banner">
            ‚ö†Ô∏è Luokitteluominaisuudet eiv√§t ole saatavilla. Tarkista ett√§ kaikki tiedostot on kopioitu oikein.
        </div>
        {% endif %}

        <!-- Leiv√§nmuru navigointi hierarkkiselle navigoinnille -->
        <div class="breadcrumb" id="breadcrumb">
            <a href="#" onclick="showMainView()">Koti</a>
        </div>

        <!-- P√§√§n√§kym√§ -->
        <div id="mainView">
            <div class="controls">
                <!-- Korvaa time-selection osio t√§ll√§: -->
<div class="time-selection">
    <div class="time-group">
        <h3>üìÖ Aikav√§li</h3>
        <div class="form-group">
            <label for="startDateTime">Alkuaika:</label>
            <input type="datetime-local" id="startDateTime" step="1800">
        </div>
        <div class="form-group">
            <label for="endDateTime">Loppuaika:</label>
            <input type="datetime-local" id="endDateTime" step="1800">
        </div>
        <div class="form-group">
            <label for="cameraSelect">Kamera:</label>
            <select id="cameraSelect">
                <option value="All">Kaikki kamerat</option>
            </select>
        </div>
        <div class="time-presets">
            <button class="preset-btn" onclick="setTimePreset('1hour')">1 tunti</button>
            <button class="preset-btn" onclick="setTimePreset('6hours')">6 tuntia</button>
            <button class="preset-btn" onclick="setTimePreset('24hours')">24 tuntia</button>
        </div>
        <button onclick="loadImagesByTimeRange()" style="margin-top: 10px;">Hae kuvat aikav√§lilt√§</button>
    </div>

    <div class="time-group">
        <h3>üîç Suodatus</h3>
        <div class="form-group">
            <label for="timeRange">Aikajana:</label>
            <input type="range" id="timeRange" class="time-slider" min="0" max="100" value="50">
            <div id="timeDisplay" class="time-display">Keskipiste</div>
        </div>
        <button onclick="applyTimeFilter()">K√§yt√§ aikasuodatin</button>
        <button onclick="clearTimeFilter()" style="background: #95a5a6; margin-top: 10px;">Tyhjenn√§ suodatin</button>
    </div>
</div>

      
                <div class="button-group">
                    <button class="classify-btn" onclick="classifyImages()" {% if not classification_available %}disabled{% endif %}>
                        üóÇÔ∏è Luokittele Kuvat
                    </button>
                    <a href="/compare" class="nav-link">
                        ‚öñÔ∏è Vertaile Kuvia
                    </a>
                    <button class="timelapse-btn" onclick="openTimelapseModal()" id="timelapseBtn" disabled>
                        üé¨ Timelapse
                    </button>
                </div>

                <!-- Hierarkkinen navigoininti -->
                <div class="hierarchy-controls">
                    <h3>üìÅ Selaa kansiorakennetta</h3>
                    <div class="folder-grid" id="categoryGrid">
                        <div class="loading">Ladataan kategorioita...</div>
                    </div>
                </div>

                <div class="rtsp-section">
                    <input type="text" id="rtspUrl" placeholder="rtsp://kamera:554/stream1">
                    <button onclick="startRTSP()" id="startRtspBtn">K√§ynnist√§ stream</button>
                    <button onclick="stopRTSP()" id="stopRtspBtn">Pys√§yt√§ stream</button>
                </div>

                <video id="hlsVideo" class="hls-video" controls></video>

                <div id="stats" class="stats" style="display: none;"></div>
            </div>

            <div id="imagesContainer" class="images-grid">
                <div class="loading">
                    Valitse aikav√§li ja klikkaa "Hae Kuvat" tai selaa kansiorakennetta yl√§puolelta
                </div>
            </div>
        </div>

        <!-- Kansion√§kym√§ hierarkkiselle navigoinnille -->
        <div id="folderView" style="display: none;">
            <div class="folder-grid" id="folderContent">
                <div class="loading">Ladataan kansiota...</div>
            </div>
        </div>
    </div>

    <!-- Timelapse Modal -->
<div id="timelapseModal" class="timelapse-modal">
    <div class="timelapse-content">
        <button class="close-btn" onclick="closeTimelapseModal()">√ó</button>
        <h2>üé¨ Timelapse-katselu</h2>
        
        <div class="timelapse-controls">
            <div class="form-group">
                <label for="timelapseStartDatetime">Alku (p√§iv√§ & aika):</label>
                <input type="datetime-local" id="timelapseStartDatetime" step="60">
            </div>
            <div class="form-group">
                <label for="timelapseEndDatetime">Loppu (p√§iv√§ & aika):</label>
                <input type="datetime-local" id="timelapseEndDatetime" step="60">
            </div>
            <div class="form-group">
                <label for="timelapseCamera">Kamera:</label>
                <select id="timelapseCamera"><option value="All">Kaikki kamerat</option></select>
            </div>
            
            <div class="speed-control">
                <label>Nopeus:</label>
                <button onclick="changeSpeed(0.125)">0.125x</button>
                <button onclick="changeSpeed(0.25)">0.25x</button>
                <button onclick="changeSpeed(0.5)">0.5x</button>
                <button onclick="changeSpeed(1)" class="active">1x</button>
                <button onclick="changeSpeed(2)">2x</button>
                <button onclick="changeSpeed(4)">4x</button>
                <button onclick="changeSpeed(8)">8x</button>
                <button onclick="changeSpeed(16)">16x</button>
            </div>
            
            <button onclick="loadTimelapseImages()" id="loadTimelapseBtn">Lataa Kuvat</button>
            <button onclick="startTimelapse()" id="startTimelapse" disabled>K√§ynnist√§</button>
            <button onclick="stopTimelapse()" id="stopTimelapse" style="display:none;">Pys√§yt√§</button>
        </div>
        
        <div id="timelapseInfo" style="text-align: center; margin: 20px 0;">
            <div id="timelapseStats">Valitse aikav√§li ja lataa kuvat</div>
        </div>
        
        <div id="timelapseContainer">
            <img id="timelapseImage" class="timelapse-image" src="" style="display:none;">
            <div id="timelapseProgress" style="text-align: center; margin: 20px 0;"></div>
        </div>
    </div>
</div>

<!-- Image modal / lightbox -->
<div id="imageModal" class="image-modal" style="display:none; align-items:center;">
    <div class="image-modal-content">
        <button class="close-btn" onclick="closeImageModal()">√ó</button>
        <img id="modalImage" src="" alt="Kuva" />
        <div id="modalMeta" class="image-modal-meta"></div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
    let currentImages = [];
    let timelapseInterval = null;
    let currentSpeed = 1;
    let currentTimelapseIndex = 0;
    let timelapseImages = [];
    let currentPath = '';
    let navigationStack = [];

    // Utility: attach click/dblclick handlers that don't conflict.
    // clickDelay ms determines how long to wait for possible dblclick.
    const CLICK_DELAY = 260;

    function makeSelectableAndZoomable(imgEl, path, filename, date_display, category) {
        // Ensure existing handlers removed
        imgEl._clickTimer = null;

        imgEl.addEventListener('click', function (e) {
            e.stopPropagation();
            // schedule single-click action (select for comparison)
            if (imgEl._clickTimer) {
                clearTimeout(imgEl._clickTimer);
            }
            imgEl._clickTimer = setTimeout(() => {
                imgEl._clickTimer = null;
                selectImage(path);
            }, CLICK_DELAY);
        });

        imgEl.addEventListener('dblclick', function (e) {
            e.stopPropagation();
            // cancel pending single-click
            if (imgEl._clickTimer) {
                clearTimeout(imgEl._clickTimer);
                imgEl._clickTimer = null;
            }
            openImageModal(path, filename, date_display, category);
        });

        // Prevent parent handlers from catching dblclick/click
        imgEl.addEventListener('mousedown', function(e){ e.stopPropagation(); });
        imgEl.addEventListener('dblclick', function(e){ e.stopPropagation(); });
    }

    // ========== HIERARKKINEN NAVIGOINTI ==========
    
    // Lataa p√§√§kategoriat
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            const categories = await response.json();
            
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            
            if (categories.length === 0) {
                grid.innerHTML = '<div class="loading">Ei kategorioita saatavilla. Suorita luokittelu ensin.</div>';
                return;
            }
            
            categories.forEach(category => {
                const card = document.createElement('div');
                card.className = 'folder-card';
                card.onclick = () => browsePath(category.path, category.name);
                
                card.innerHTML = `
                    <div class="folder-icon">${category.icon}</div>
                    <div><strong>${category.name}</strong></div>
                    <div class="folder-count">${category.count} kuvaa</div>
                `;
                
                grid.appendChild(card);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
            document.getElementById('categoryGrid').innerHTML = '<div class="loading">Virhe kategorioiden latauksessa</div>';
        }
    }

    // Selaa polkua
    async function browsePath(path, name) {
        try {
            // Tallenna nykyinen tila pinoon
            if (currentPath) {
                navigationStack.push({
                    path: currentPath,
                    name: document.getElementById('breadcrumb').innerText.split('/').pop().trim()
                });
            }
            
            const response = await fetch('/api/browse?path=' + encodeURIComponent(path));
            const result = await response.json();
            
            if (result.error) {
                alert('Virhe: ' + result.error);
                return;
            }
            
            currentPath = path;
            updateBreadcrumb(name, path);
            
            // N√§yt√§ kansio n√§kym√§
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('folderView').style.display = 'block';
            
            const folderContent = document.getElementById('folderContent');
            folderContent.innerHTML = '';
            
            // Lis√§√§ paluunappi jos pino ei ole tyhj√§
            if (navigationStack.length > 0) {
                const backCard = document.createElement('div');
                backCard.className = 'folder-card';
                backCard.onclick = goBack;
                backCard.innerHTML = `
                    <div class="folder-icon">‚Ü©Ô∏è</div>
                    <div><strong>Takaisin</strong></div>
                    <div class="folder-count">Edelliseen tasoon</div>
                `;
                folderContent.appendChild(backCard);
            }
            
            // N√§yt√§ alikansiot
            if (result.folders && result.folders.length > 0) {
                result.folders.forEach(folder => {
                    const card = document.createElement('div');
                    card.className = 'folder-card';
                    card.onclick = () => browsePath(folder.path, folder.name);
                    
                    card.innerHTML = `
                        <div class="folder-icon">üìÅ</div>
                        <div><strong>${folder.name}</strong></div>
                        <div class="folder-count">${folder.image_count} kuvaa</div>
                    `;
                    
                    folderContent.appendChild(card);
                });
            }
            
            // N√§yt√§ kuvat
            if (result.images && result.images.length > 0) {
                result.images.forEach(image => {
                    const card = document.createElement('div');
                    card.className = 'image-card';
                    // Poistetaan kortille suora onclick, k√§ytet√§√§n kuvalle click/dblclick
                    // card.onclick = () => selectImage(image.path);
                    
                    card.innerHTML = `
                        <img src="/images/${image.path}" data-path="${image.path}" data-filename="${image.filename}" data-date="${image.date_display || ''}" data-category="${image.category || ''}" alt="${image.filename}" onerror="this.style.display='none'">
                        <div class="image-info">
                            <h3>${image.filename}</h3>
                            <div class="image-meta">
                                <div>${image.date_display || 'Tuntematon'}</div>
                            </div>
                        </div>
                    `;
                    
                    folderContent.appendChild(card);
                });

                // Lis√§√§ click/dblclick -tapahtumat kuville (prepare handlers)
                folderContent.querySelectorAll('.image-card img').forEach(img => {
                    const path = img.dataset.path;
                    const filename = img.dataset.filename;
                    const date = img.dataset.date;
                    const category = img.dataset.category;
                    makeSelectableAndZoomable(img, path, filename, date, category);
                });
            }
            
            if ((result.folders && result.folders.length === 0) && (result.images && result.images.length === 0)) {
                folderContent.innerHTML = '<div class="loading">Tyhj√§ kansio</div>';
            }
            
        } catch (error) {
            console.error('Error browsing path:', error);
            document.getElementById('folderContent').innerHTML = '<div class="loading">Virhe kansiota selatessa</div>';
        }
    }

    // Paluu edelliseen kansioon
    function goBack() {
        if (navigationStack.length > 0) {
            const previous = navigationStack.pop();
            browsePath(previous.path, previous.name);
        }
    }

    // P√§ivit√§ leiv√§nmurut
    function updateBreadcrumb(name, path) {
        const breadcrumb = document.getElementById('breadcrumb');
        let breadcrumbHtml = '<a href="#" onclick="showMainView()">Koti</a>';
        
        // Lis√§√§ kaikki navigointipolun osat
        const pathParts = path.split('/');
        let currentPath = '';
        
        for (let i = 0; i < pathParts.length; i++) {
            currentPath += (currentPath ? '/' : '') + pathParts[i];
            const partName = i === pathParts.length - 1 ? name : pathParts[i];
            breadcrumbHtml += ` / <a href="#" onclick="browsePath('${currentPath}', '${partName}')">${partName}</a>`;
        }
        
        breadcrumb.innerHTML = breadcrumbHtml;
    }

    // N√§yt√§ p√§√§ n√§kym√§
    function showMainView() {
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('folderView').style.display = 'none';
        currentPath = '';
        navigationStack = [];
        document.getElementById('breadcrumb').innerHTML = '<a href="#" onclick="showMainView()">Koti</a>';
        loadCategories();
    }

    // ========== AIKAV√ÑLIHALLINTA ==========

    // Aikapresetit
    function setTimePreset(preset) {
        const endDate = new Date();
        let startDate = new Date();
        
        switch(preset) {
            case '1hour':
                startDate.setHours(endDate.getHours() - 1);
                break;
            case '6hours':
                startDate.setHours(endDate.getHours() - 6);
                break;
            case '24hours':
                startDate.setDate(endDate.getDate() - 1);
                break;
        }
        
        // Aseta datetime-local kenttiin (paikallinen aika)
        document.getElementById('startDateTime').value = formatDateTimeLocal(startDate);
        document.getElementById('endDateTime').value = formatDateTimeLocal(endDate);
        loadImagesByTimeRange();
    }

    // Apufunktio datetime-local muotoon (palauttaa paikallisen wall-clock arvon)
    function formatDateTimeLocal(date) {
        // date is a Date object. We need a string like "YYYY-MM-DDTHH:MM" representing local wall-clock time.
        // To do that reliably we subtract the timezone offset in minutes.
        const tzOffset = date.getTimezoneOffset() * 60000; // ms
        const localISO = new Date(date.getTime() - tzOffset).toISOString().slice(0,16);
        return localISO;
    }

    // Hae kamerat ja t√§yt√§ select
    async function loadCamerasToSelect() {
        try {
            const res = await fetch('/api/cameras');
            const cams = await res.json();
            const sel = document.getElementById('cameraSelect');
            sel.innerHTML = '';
            const timelapseSel = document.getElementById('timelapseCamera');
            if (timelapseSel) timelapseSel.innerHTML = '';
            cams.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = (c === 'All') ? 'Kaikki kamerat' : c;
                sel.appendChild(opt);
                if (timelapseSel) {
                    const opt2 = opt.cloneNode(true);
                    timelapseSel.appendChild(opt2);
                }
            });
        } catch (e) {
            console.warn('camera list fetch error', e);
        }
    }

    // Hae kuvat tarkalla aikav√§lill√§
    async function loadImagesByTimeRange() {
        const startDateTime = document.getElementById('startDateTime').value;
        const endDateTime = document.getElementById('endDateTime').value;
        const camera = document.getElementById('cameraSelect').value || 'All';

        if (!startDateTime || !endDateTime) {
            alert('Valitse alkuaika ja loppuaika!');
            return;
        }

        const container = document.getElementById('imagesContainer');
        container.innerHTML = '<div class="loading">Haetaan kuvia...</div>';

        try {
            // Convert local datetime-local values to timezone-aware ISO (UTC) before sending
            const startIso = new Date(startDateTime).toISOString();
            const endIso = new Date(endDateTime).toISOString();
            const url = `/api/filter_by_time_range?start_datetime=${encodeURIComponent(startIso)}&end_datetime=${encodeURIComponent(endIso)}&camera=${encodeURIComponent(camera)}`;
            const response = await fetch(url);
            const images = await response.json();
            displayImages(images, `Aikav√§li: ${startDateTime} - ${endDateTime} (Kamera: ${camera})`);
            
        } catch (error) {
            container.innerHTML = '<div class="loading">Virhe kuvien haussa</div>';
            console.error('Error:', error);
        }
    }

    // N√§yt√§ kuvat
    function displayImages(images, title) {
        const container = document.getElementById('imagesContainer');
        currentImages = images;

        if (!images || images.length === 0) {
            container.innerHTML = '<div class="loading">Ei kuvia l√∂ytynyt valitulla aikav√§lill√§</div>';
            document.getElementById('timelapseBtn').disabled = true;
            return;
        }

        document.getElementById('timelapseBtn').disabled = false;

        // P√§ivit√§ aikajanan maksimiarvo
        document.getElementById('timeRange').max = images.length - 1;
        updateTimeDisplay();

        container.innerHTML = `
            <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                <h3>${title}</h3>
                <p>L√∂ytyi ${images.length} kuvaa</p>
            </div>
            ${images.map((image, index) => `
                <div class="image-card" data-index="${index}">
                    <img src="/images/${image.path}" data-path="${image.path}" data-filename="${image.filename}" data-date="${image.date_display || ''}" data-category="${image.category || ''}" alt="${image.filename}" onerror="this.style.display='none'">
                    <div class="image-info">
                        <h3>${image.filename}</h3>
                        <div class="image-meta">
                            <div>${image.date_display}</div>
                            <div>${image.category || ''}</div>
                        </div>
                    </div>
                </div>
            `).join('')}
        `;

        // Asenna click/dblclick-kuuntelijat, jotta k√§ytt√§j√§ voi suurentaa kuvan kaksois‚Äëklikkauksella (single click valitsee vertailuun)
        container.querySelectorAll('.image-card img').forEach(img => {
            const path = img.dataset.path;
            const filename = img.dataset.filename;
            const date = img.dataset.date;
            const category = img.dataset.category;
            makeSelectableAndZoomable(img, path, filename, date, category);
        });
    }

    // P√§ivit√§ aikajanan n√§ytt√∂
    function updateTimeDisplay() {
        const slider = document.getElementById('timeRange');
        const display = document.getElementById('timeDisplay');
        const index = parseInt(slider.value);
        
        if (currentImages[index]) {
            const image = currentImages[index];
            display.textContent = `Kuva ${index + 1}/${currentImages.length}: ${image.date_display}`;
        }
    }

    // K√§yt√§ aikasuodatinta
    function applyTimeFilter() {
        const slider = document.getElementById('timeRange');
        const index = parseInt(slider.value);
        
        if (currentImages[index]) {
            // Korosta valittu kuva
            document.querySelectorAll('.image-card').forEach(card => {
                card.style.opacity = '0.6';
            });
            
            const selectedCard = document.querySelector(`.image-card[data-index="${index}"]`);
            if (selectedCard) {
                selectedCard.style.opacity = '1';
                selectedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }

    // Tyhjenn√§ aikasuodatin
    function clearTimeFilter() {
        document.querySelectorAll('.image-card').forEach(card => {
            card.style.opacity = '1';
        });
        if (currentImages && currentImages.length > 0) {
            document.getElementById('timeRange').value = Math.floor(currentImages.length / 2);
        } else {
            document.getElementById('timeRange').value = 0;
        }
        updateTimeDisplay();
    }

    // ========== MUUT TOIMINNOT ==========

    function selectImage(imagePath) {
        sessionStorage.setItem('selectedImage', imagePath);
        alert('Kuva valittu vertailua varten! Mene "Vertaile Kuvia" -sivulle.');
    }

    // Image modal functions
    function openImageModal(path, filename, date_display, category) {
        try {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const meta = document.getElementById('modalMeta');
            modalImg.src = `/images/${path}`;
            meta.innerHTML = `<div><strong>${filename || ''}</strong></div>
                              <div>${date_display || ''}</div>
                              <div>${category || ''}</div>`;
            modal.style.display = 'flex';
            // close on Escape
            document.addEventListener('keydown', _imageModalKeyHandler);
        } catch (e) {
            console.error('openImageModal error', e);
        }
    }
    function closeImageModal() {
        try {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = '';
            modal.style.display = 'none';
            document.removeEventListener('keydown', _imageModalKeyHandler);
        } catch (e) {
            console.error('closeImageModal error', e);
        }
    }
    function _imageModalKeyHandler(e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    }

    // Luokittelu
    async function classifyImages() {
        try {
            const response = await fetch('/api/classify', { method: 'POST' });
            const result = await response.json();

            if (result.success) {
                showStats(result.result);
                alert('Kuvien luokittelu valmis!');
                loadCategories(); // P√§ivit√§ hierarkkinen navigointi
            } else {
                alert('Luokittelu ep√§onnistui: ' + result.error);
            }
        } catch (error) {
            alert('Virhe luokittelussa: ' + error.message);
        }
    }

    function showStats(result) {
        const statsDiv = document.getElementById('stats');
        const stats = result.stats;
        const classified = result.classified;

        statsDiv.innerHTML = `
            <div class="stat-card">
                <div class="stat-number">${stats.total}</div>
                <div>Yhteens√§ kuvia</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.filesystem}</div>
                <div>Tiedostoj√§rjestelm√§</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${classified.year.images}</div>
                <div>Vuosikuvia</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${classified.minute.images}</div>
                <div>Minuuttikuvia</div>
            </div>
        `;
        statsDiv.style.display = 'grid';
    }

    // RTSP / HLS -toiminnot
    let current_stream = null;
    async function startRTSP() {
        const url = document.getElementById('rtspUrl').value;
        if (!url) { alert('Anna RTSP-URL'); return; }
        try {
            const res = await fetch('/api/rtsp/start', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({url})
            });
            const body = await res.json();
            if (body.playlist) {
                current_stream = body;
                playHls(body.playlist);
            } else {
                alert('Streamin k√§ynnistys ep√§onnistui: ' + (body.error || 'Tuntematon virhe'));
            }
        } catch (err) {
            alert('RTSP start virhe: ' + err.message);
        }
    }

    async function stopRTSP() {
        if (!current_stream) {
            alert('Ei k√§ynniss√§ olevaa streamia');
            return;
        }
        try {
            const res = await fetch('/api/rtsp/stop', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({stream_id: current_stream.stream_id})
            });
            const body = await res.json();
            if (body.status === 'stopped' || body.status === 'not_found') {
                alert('Stream pys√§ytetty');
                const v = document.getElementById('hlsVideo');
                if (v) { v.pause(); v.style.display='none'; v.src=''; }
                current_stream = null;
            } else {
                alert('Pys√§ytys ep√§onnistui');
            }
        } catch (err) {
            alert('RTSP stop virhe: ' + err.message);
        }
    }

    function playHls(playlist) {
        const video = document.getElementById('hlsVideo');
        const videoSrc = playlist;
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(videoSrc);
            hls.attachMedia(video);
            video.style.display = 'block';
            video.play().catch(()=>{});
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoSrc;
            video.style.display = 'block';
            video.play().catch(()=>{});
        } else {
            alert('Selaimesi ei tue HLS-soitinta suoraan');
        }
    }

    // Timelapse-toiminnot
    function openTimelapseModal() {
        document.getElementById('timelapseModal').style.display = 'flex';
        // Aseta oletusarvot
        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000));
        // aseta datetime-local oletusarvoiksi viimeinen tunti
        const startEl = document.getElementById('timelapseStartDatetime');
        const endEl = document.getElementById('timelapseEndDatetime');
        if (startEl && endEl) {
            startEl.value = formatDateTimeLocal(oneHourAgo);
            endEl.value = formatDateTimeLocal(now);
        }
        // varmista kameralistat
        loadCamerasToSelect();
    }

    function closeTimelapseModal() {
        document.getElementById('timelapseModal').style.display = 'none';
        stopTimelapse();
    }

    // Lataa timelapse-kuvat
    async function loadTimelapseImages() {
        const startLocal = document.getElementById('timelapseStartDatetime').value;
        const endLocal = document.getElementById('timelapseEndDatetime').value;
        const camera = document.getElementById('timelapseCamera') ? document.getElementById('timelapseCamera').value : (document.getElementById('cameraSelect') ? document.getElementById('cameraSelect').value : 'All');

        if (!startLocal || !endLocal) {
            alert('Valitse alkuaika ja loppuaika timelapsea varten!');
            return;
        }

        try {
            document.getElementById('timelapseStats').innerHTML = 'Ladataan kuvia...';
            // Convert to timezone-aware ISO (UTC) for backend
            const startIso = new Date(startLocal).toISOString();
            const endIso = new Date(endLocal).toISOString();
            const url = `/api/filter_by_time_range?start_datetime=${encodeURIComponent(startIso)}&end_datetime=${encodeURIComponent(endIso)}&camera=${encodeURIComponent(camera)}`;
            const response = await fetch(url);
            let images = await response.json();

            images = images.filter(img => img && img.timestamp).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

            timelapseImages = images;

            if (timelapseImages.length === 0) {
                document.getElementById('timelapseStats').innerHTML = 
                    `Ei kuvia aikav√§lill√§ ${startLocal} - ${endLocal} (Kamera: ${camera})`;
                document.getElementById('startTimelapse').disabled = true;
                return;
            }

            document.getElementById('timelapseStats').innerHTML = 
                `Ladattu ${timelapseImages.length} kuvaa aikav√§lilt√§ ${startLocal} - ${endLocal} (Kamera: ${camera})`;
            document.getElementById('startTimelapse').disabled = false;
            
            if (timelapseImages.length > 0) {
                const firstImage = timelapseImages[0];
                document.getElementById('timelapseImage').src = `/images/${firstImage.path}`;
                document.getElementById('timelapseImage').style.display = 'block';
                document.getElementById('timelapseProgress').innerHTML = 
                    `Kuva 1/${timelapseImages.length}: ${firstImage.date_display}`;
            }
            
        } catch (error) {
            console.error('Error loading timelapse images:', error);
            document.getElementById('timelapseStats').innerHTML = 'Virhe kuvien latauksessa';
        }
    }

    function changeSpeed(speed) {
        currentSpeed = speed;
        document.querySelectorAll('.speed-control button').forEach(btn => {
            btn.classList.remove('active');
        });
        try { event.target.classList.add('active'); } catch (e) {}
        
        if (timelapseInterval) {
            stopTimelapse();
            startTimelapse();
        }
    }

    function startTimelapse() {
        if (timelapseImages.length === 0) {
            alert('Lataa kuvat ensin!');
            return;
        }
        
        document.getElementById('startTimelapse').style.display = 'none';
        document.getElementById('stopTimelapse').style.display = 'inline-block';
        document.getElementById('loadTimelapseBtn').disabled = true;
        
        currentTimelapseIndex = 0;
        const intervalTime = 1000 / currentSpeed;
        
        timelapseInterval = setInterval(() => {
            if (currentTimelapseIndex >= timelapseImages.length) {
                currentTimelapseIndex = 0;
            }
            
            const image = timelapseImages[currentTimelapseIndex];
            const timelapseImage = document.getElementById('timelapseImage');
            const timelapseProgress = document.getElementById('timelapseProgress');
            
            timelapseImage.src = `/images/${image.path}`;
            timelapseImage.style.display = 'block';
            timelapseProgress.innerHTML = `
                <strong>${image.filename}</strong><br>
                ${image.date_display}<br>
                ${image.category || ''}<br>
                Kuva ${currentTimelapseIndex + 1} / ${timelapseImages.length}<br>
                Nopeus: ${currentSpeed}x
            `;
            
            currentTimelapseIndex++;
        }, intervalTime);
    }

    function stopTimelapse() {
        if (timelapseInterval) {
            clearInterval(timelapseInterval);
            timelapseInterval = null;
        }
        document.getElementById('startTimelapse').style.display = 'inline-block';
        document.getElementById('stopTimelapse').style.display = 'none';
        document.getElementById('loadTimelapseBtn').disabled = false;
    }

    // Alustus
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000));
        
        document.getElementById('startDateTime').value = formatDateTimeLocal(oneHourAgo);
        document.getElementById('endDateTime').value = formatDateTimeLocal(now);
        
        document.getElementById('timeRange').addEventListener('input', updateTimeDisplay);
        
        showMainView();
        loadCamerasToSelect();
        
        loadImagesByTimeRange();
    });
</script>
</body>
</html>
    