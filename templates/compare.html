
<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuvavertailu</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
        .container { max-width:1600px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; }
        .header { background: linear-gradient(135deg,#2c3e50 0%,#3498db 100%); color:white; padding:30px; text-align:center; }
        .header h1 { font-size:2.5em; margin-bottom:10px; }
        .comparison-section { padding:30px; }
        .time-selection { display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-bottom:30px; }
        .time-group { background:#f8f9fa; padding:20px; border-radius:10px; border:2px solid #e9ecef; }
        .form-group { display:flex; flex-direction:column; margin-bottom:15px; }
        label { font-weight:600; margin-bottom:5px; color:#495057; }
        input, select, button { padding:12px 15px; border:2px solid #e9ecef; border-radius:8px; font-size:16px; transition:all 0.3s ease; }
        button { background: linear-gradient(135deg,#3498db 0%,#2980b9 100%); color:white; border:none; cursor:pointer; font-weight:600; }
        .image-selectors { display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-bottom:30px; }
        .selector { background:#f8f9fa; padding:20px; border-radius:10px; }
        .image-preview { width:100%; height:300px; background:#e9ecef; border-radius:8px; margin-bottom:15px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
        .image-preview img { max-width:100%; max-height:100%; object-fit:contain; }
        .image-scroller { display:flex; align-items:center; gap:10px; margin:10px 0; }
        .scroll-btn { padding:10px; background:#6c757d; color:white; border:none; border-radius:5px; cursor:pointer; }
        .image-counter { text-align:center; font-weight:bold; color:#495057; }
        .image-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px; margin-top:15px; max-height:200px; overflow-y:auto; }
        .grid-image { width:100%; height:80px; object-fit:cover; border-radius:6px; cursor:pointer; transition:all 0.3s ease; }
        .grid-image:hover { transform:scale(1.05); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .selected { border:3px solid #3498db; box-shadow:0 0 0 3px rgba(52,152,219,0.3); }
        .comparison-container { position:relative; width:100%; height:600px; background:#000; border-radius:12px; overflow:hidden; margin-bottom:20px; }
        .comparison-image { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; }
        .image-before { z-index:1; }
        .image-after { z-index:2; clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%); }
        .slider-container { position:absolute; top:0; left:0; width:100%; height:100%; z-index:3; }
        .slider { position:absolute; top:0; left:50%; transform:translateX(-50%); width:4px; height:100%; background:#3498db; cursor:ew-resize; }
        .slider-handle { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:50px; height:50px; background:#3498db; border-radius:50%; border:4px solid white; box-shadow:0 2px 6px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; }
        .controls { display:flex; gap:15px; justify-content:center; margin-top:20px; }
        .back-btn { background: linear-gradient(135deg,#95a5a6 0%,#7f8c8d 100%); }
        /* Image modal (lightbox) */
        .image-modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; }
        .image-modal-content { position:relative; margin:auto; max-width:95%; max-height:95%; background:transparent; padding:20px; text-align:center; color:#fff; }
        .image-modal-content img { max-width:100%; max-height:80vh; border-radius:8px; border:2px solid #ffffff33; }
        .image-modal-meta { margin-top:10px; color:#ddd; font-size:14px; }
        .image-modal .close-btn { position:absolute; top:-10px; right:-10px; background:#e74c3c; color:white; border:none; border-radius:50%; width:40px; height:40px; font-size:20px; cursor:pointer; z-index:2100; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öñÔ∏è Kuvavertailu</h1>
            <p>Vertaa kahta kuvaa eri ajoista liukus√§√§timell√§</p>
        </div>

        <div class="comparison-section">
            <!-- Aikavalinta: k√§ytt√§j√§ voi m√§√§ritell√§ aikav√§lin BEFORE ja AFTER -->
            <div class="time-selection">
                <div class="time-group">
                    <h3>üìÖ Vanhemmat kuvat ‚Äî aikav√§li</h3>
                    <div class="form-group">
                        <label for="beforeStart">Alku (p√§iv√§ & aika):</label>
                        <input type="datetime-local" id="beforeStart" step="60" />
                    </div>
                    <div class="form-group">
                        <label for="beforeEnd">Loppu (valinnainen):</label>
                        <input type="datetime-local" id="beforeEnd" step="60" />
                    </div>
                    <div class="form-group">
                        <label for="beforeCamera">Kamerat:</label>
                        <select id="beforeCamera"><option>All</option></select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="loadBeforeImages()">Hae kuvat valitulta aikav√§lilt√§</button>
                        <button onclick="loadSelectedFromSession()">Valittu istunnosta</button>
                    </div>
                    <div style="margin-top:8px; color:#7f8c8d; font-size:13px;">
                        Jos loppuaikaa ei anneta, haetaan yhden tunnin alue aloitushetkest√§ (alkaen :00).
                    </div>
                </div>

                <div class="time-group">
                    <h3>üìÖ Uudemmat kuvat ‚Äî aikav√§li</h3>
                    <div class="form-group">
                        <label for="afterStart">Alku (p√§iv√§ & aika):</label>
                        <input type="datetime-local" id="afterStart" step="60" />
                    </div>
                    <div class="form-group">
                        <label for="afterEnd">Loppu (valinnainen):</label>
                        <input type="datetime-local" id="afterEnd" step="60" />
                    </div>
                    <div class="form-group">
                        <label for="afterCamera">Kamerat:</label>
                        <select id="afterCamera"><option>All</option></select>
                    </div>
                    <div style="margin-top:10px;">
                        <button onclick="loadAfterImages()">Hae kuvat valitulta aikav√§lilt√§</button>
                    </div>
                    <div style="margin-top:8px; color:#7f8c8d; font-size:13px;">
                        Jos loppuaikaa ei anneta, haetaan yhden tunnin alue aloitushetkest√§ (alkaen :00).
                    </div>
                </div>
            </div>

            <!-- Kuvien valinta -->
            <div class="image-selectors">
                <div class="selector">
                    <h3>Vanha Kuva (Vasen)</h3>
                    <div class="image-preview" id="beforePreview">
                        <div style="color: #7f8c8d;">Valitse kuva</div>
                    </div>
                    <div class="image-scroller">
                        <button class="scroll-btn" onclick="scrollBeforeImage(-1)">‚óÄ</button>
                        <div class="image-counter" id="beforeCounter">0/0</div>
                        <button class="scroll-btn" onclick="scrollBeforeImage(1)">‚ñ∂</button>
                    </div>
                    <div class="image-grid" id="beforeGrid"></div>
                </div>

                <div class="selector">
                    <h3>Uusi Kuva (Oikea)</h3>
                    <div class="image-preview" id="afterPreview">
                        <div style="color: #7f8c8d;">Valitse kuva</div>
                    </div>
                    <div class="image-scroller">
                        <button class="scroll-btn" onclick="scrollAfterImage(-1)">‚óÄ</button>
                        <div class="image-counter" id="afterCounter">0/0</div>
                        <button class="scroll-btn" onclick="scrollAfterImage(1)">‚ñ∂</button>
                    </div>
                    <div class="image-grid" id="afterGrid"></div>
                </div>
            </div>

            <!-- Vertailu -->
            <div class="comparison-container" id="comparisonContainer" style="display: none;">
                <img id="beforeImage" class="comparison-image image-before" src="" alt="Vanha kuva">
                <img id="afterImage" class="comparison-image image-after" src="" alt="Uusi kuva">
                <div class="slider-container">
                    <div class="slider">
                        <div class="slider-handle">‚áÑ</div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="back-btn" onclick="window.location.href='/'">‚Üê Takaisin</button>
                <button onclick="startComparison()" id="compareBtn" disabled>Aloita Vertailu</button>
                <button onclick="resetComparison()">Nollaa Valinnat</button>
            </div>
        </div>
    </div>

<!-- Image modal / lightbox -->
<div id="imageModal" class="image-modal" style="display:none; align-items:center;">
    <div class="image-modal-content">
        <button class="close-btn" onclick="closeImageModal()">√ó</button>
        <img id="modalImage" src="" alt="Kuva" />
        <div id="modalMeta" class="image-modal-meta"></div>
    </div>
</div>

    <script>
        const CLICK_DELAY = 260;

        let beforeImages = [];
        let afterImages = [];
        let currentBeforeIndex = 0;
        let currentAfterIndex = 0;
        let selectedImages = {
            before: null,
            after: null
        };

        function formatDateTimeLocal(date) {
            // return local wall-clock string suitable for <input type="datetime-local">
            const tzOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - tzOffset).toISOString().slice(0,16);
        }

        function makeSelectableAndZoomable(imgEl, path, filename, date_display, category) {
            imgEl._clickTimer = null;

            imgEl.addEventListener('click', function (e) {
                e.stopPropagation();
                if (imgEl._clickTimer) clearTimeout(imgEl._clickTimer);
                imgEl._clickTimer = setTimeout(() => {
                    imgEl._clickTimer = null;
                    // single click acts as selecting image for compare grid context
                    if (imgEl.dataset.for === 'before') {
                        // find index in beforeImages
                        const idx = beforeImages.findIndex(x => x.path === path);
                        if (idx >= 0) {
                            currentBeforeIndex = idx;
                            updateBeforeDisplay();
                        }
                    } else if (imgEl.dataset.for === 'after') {
                        const idx = afterImages.findIndex(x => x.path === path);
                        if (idx >= 0) {
                            currentAfterIndex = idx;
                            updateAfterDisplay();
                        }
                    } else {
                        // fallback: set as before selection
                        beforeImages = [ { path: path, filename: filename, date_display: date_display, category: category, timestamp: '' } ];
                        currentBeforeIndex = 0;
                        updateBeforeDisplay();
                    }
                }, CLICK_DELAY);
            });

            imgEl.addEventListener('dblclick', function (e) {
                e.stopPropagation();
                if (imgEl._clickTimer) { clearTimeout(imgEl._clickTimer); imgEl._clickTimer = null; }
                openImageModal(path, filename, date_display, category);
            });

            imgEl.addEventListener('mousedown', function(e){ e.stopPropagation(); });
        }

        async function populateCompareCameras() {
            try {
                const res = await fetch('/api/cameras');
                const cams = await res.json();
                const b = document.getElementById('beforeCamera');
                const a = document.getElementById('afterCamera');
                b.innerHTML = ''; a.innerHTML = '';
                cams.forEach(c => {
                    const opt1 = document.createElement('option');
                    opt1.value = c; opt1.textContent = (c==='All') ? 'Kaikki kamerat' : c;
                    b.appendChild(opt1);
                    const opt2 = opt1.cloneNode(true);
                    a.appendChild(opt2);
                });
            } catch (e) { console.warn('pop cameras failed', e); }
        }

        async function loadBeforeImages() {
            const startLocal = document.getElementById('beforeStart').value;
            const endLocal = document.getElementById('beforeEnd').value;
            const camera = document.getElementById('beforeCamera').value || 'All';

            if (!startLocal) {
                alert('Valitse p√§iv√§m√§√§r√§ ja aika ensin');
                return;
            }

            try {
                const start = new Date(startLocal);
                let end;
                if (endLocal) {
                    end = new Date(endLocal);
                } else {
                    const tmp = new Date(start);
                    tmp.setMinutes(0,0,0);
                    end = new Date(tmp.getTime() + 3600*1000 - 1);
                }

                const startIso = start.toISOString();
                const endIso = end.toISOString();

                const response = await fetch(`/api/filter_by_time_range?start_datetime=${encodeURIComponent(startIso)}&end_datetime=${encodeURIComponent(endIso)}&camera=${encodeURIComponent(camera)}`);
                const images = await response.json();

                beforeImages = images.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                currentBeforeIndex = 0;

                if (beforeImages.length === 0) {
                    alert(`Ei kuvia valitulla aikav√§lill√§.`);
                } else {
                    alert(`L√∂ytyi ${beforeImages.length} kuvaa aikav√§lilt√§.`);
                }

                updateBeforeDisplay();
                populateImageGrid('beforeGrid', beforeImages, 'before');
            } catch (error) {
                console.error('Error loading before images:', error);
                alert('Virhe kuvien haussa');
            }
        }

        async function loadAfterImages() {
            const startLocal = document.getElementById('afterStart').value;
            const endLocal = document.getElementById('afterEnd').value;
            const camera = document.getElementById('afterCamera').value || 'All';

            if (!startLocal) {
                alert('Valitse p√§iv√§m√§√§r√§ ja aika ensin');
                return;
            }

            try {
                const start = new Date(startLocal);
                let end;
                if (endLocal) {
                    end = new Date(endLocal);
                } else {
                    const tmp = new Date(start);
                    tmp.setMinutes(0,0,0);
                    end = new Date(tmp.getTime() + 3600*1000 - 1);
                }

                const startIso = start.toISOString();
                const endIso = end.toISOString();

                const response = await fetch(`/api/filter_by_time_range?start_datetime=${encodeURIComponent(startIso)}&end_datetime=${encodeURIComponent(endIso)}&camera=${encodeURIComponent(camera)}`);
                const images = await response.json();

                afterImages = images.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                currentAfterIndex = 0;

                if (afterImages.length === 0) {
                    alert(`Ei kuvia valitulla aikav√§lill√§.`);
                } else {
                    alert(`L√∂ytyi ${afterImages.length} kuvaa aikav√§lilt√§.`);
                }

                updateAfterDisplay();
                populateImageGrid('afterGrid', afterImages, 'after');
            } catch (error) {
                console.error('Error loading after images:', error);
                alert('Virhe kuvien haussa');
            }
        }

        function updateBeforeDisplay() {
            const counter = document.getElementById('beforeCounter');
            const preview = document.getElementById('beforePreview');
            
            counter.textContent = `${currentBeforeIndex + 1}/${beforeImages.length}`;
            
            if (beforeImages.length > 0) {
                const image = beforeImages[currentBeforeIndex];
                preview.innerHTML = `<img src="/images/${image.path}" alt="${image.filename}" data-path="${image.path}" data-filename="${image.filename}" data-date="${image.date_display || ''}" data-category="${image.category || ''}">`;
                selectedImages.before = image;

                const prevImg = preview.querySelector('img');
                if (prevImg) {
                    prevImg.dataset.for = 'before';
                    makeSelectableAndZoomable(prevImg, prevImg.dataset.path, prevImg.dataset.filename, prevImg.dataset.date, prevImg.dataset.category);
                }
            } else {
                preview.innerHTML = '<div style="color: #7f8c8d;">Ei kuvia</div>';
                selectedImages.before = null;
            }
            
            updateCompareButton();
        }

        function updateAfterDisplay() {
            const counter = document.getElementById('afterCounter');
            const preview = document.getElementById('afterPreview');
            
            counter.textContent = `${currentAfterIndex + 1}/${afterImages.length}`;
            
            if (afterImages.length > 0) {
                const image = afterImages[currentAfterIndex];
                preview.innerHTML = `<img src="/images/${image.path}" alt="${image.filename}" data-path="${image.path}" data-filename="${image.filename}" data-date="${image.date_display || ''}" data-category="${image.category || ''}">`;
                selectedImages.after = image;

                const prevImg = preview.querySelector('img');
                if (prevImg) {
                    prevImg.dataset.for = 'after';
                    makeSelectableAndZoomable(prevImg, prevImg.dataset.path, prevImg.dataset.filename, prevImg.dataset.date, prevImg.dataset.category);
                }
            } else {
                preview.innerHTML = '<div style="color: #7f8c8d;">Ei kuvia</div>';
                selectedImages.after = null;
            }
            
            updateCompareButton();
        }

        function scrollBeforeImage(direction) {
            if (beforeImages.length === 0) return;
            
            currentBeforeIndex = (currentBeforeIndex + direction + beforeImages.length) % beforeImages.length;
            updateBeforeDisplay();
        }

        function scrollAfterImage(direction) {
            if (afterImages.length === 0) return;
            
            currentAfterIndex = (currentAfterIndex + direction + afterImages.length) % afterImages.length;
            updateAfterDisplay();
        }

        function populateImageGrid(gridId, images, type) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            images.forEach((image, index) => {
                const img = document.createElement('img');
                img.src = `/images/${image.path}`;
                img.className = 'grid-image';
                img.title = `${image.filename}\n${image.date_display}`;
                img.dataset.path = image.path;
                img.dataset.filename = image.filename;
                img.dataset.date = image.date_display || '';
                img.dataset.category = image.category || '';
                img.dataset.for = type;
                img.onerror = function() { this.style.display = 'none'; };
                
                img.addEventListener('click', () => {
                    // click handled by makeSelectableAndZoomable (which also schedules)
                });
                
                img.addEventListener('dblclick', (e) => {
                    // dblclick handled by makeSelectableAndZoomable
                    e.stopPropagation();
                });

                makeSelectableAndZoomable(img, image.path, image.filename, image.date_display || '', image.category || '');

                grid.appendChild(img);
            });
        }

        function updateCompareButton() {
            const btn = document.getElementById('compareBtn');
            btn.disabled = !(selectedImages.before && selectedImages.after);
        }

        function startComparison() {
            if (!selectedImages.before || !selectedImages.after) return;

            document.getElementById('beforeImage').src = `/images/${selectedImages.before.path}`;
            document.getElementById('afterImage').src = `/images/${selectedImages.after.path}`;
            document.getElementById('comparisonContainer').style.display = 'block';

            initSlider();
        }

        function resetComparison() {
            beforeImages = [];
            afterImages = [];
            currentBeforeIndex = 0;
            currentAfterIndex = 0;
            selectedImages.before = null;
            selectedImages.after = null;
            
            document.getElementById('beforePreview').innerHTML = '<div style="color: #7f8c8d;">Valitse kuva</div>';
            document.getElementById('afterPreview').innerHTML = '<div style="color: #7f8c8d;">Valitse kuva</div>';
            document.getElementById('beforeCounter').textContent = '0/0';
            document.getElementById('afterCounter').textContent = '0/0';
            document.getElementById('beforeGrid').innerHTML = '';
            document.getElementById('afterGrid').innerHTML = '';
            document.getElementById('comparisonContainer').style.display = 'none';
            
            updateCompareButton();
        }

        function initSlider() {
            const sliderContainer = document.querySelector('.slider-container');
            const sliderBar = document.querySelector('.slider');
            const handle = document.querySelector('.slider-handle');
            const afterImage = document.querySelector('.image-after');
            let isDragging = false;

            function updateSliderPosition(clientX) {
                const container = document.querySelector('.comparison-container');
                const rect = container.getBoundingClientRect();
                let percentage = ((clientX - rect.left) / rect.width) * 100;
                percentage = Math.max(0, Math.min(100, percentage));
                afterImage.style.clipPath = `polygon(0 0, ${percentage}% 0, ${percentage}% 100%, 0 100%)`;
                sliderBar.style.left = `${percentage}%`;
                handle.style.left = `${percentage}%`;
            }

            sliderContainer.addEventListener('pointerdown', function(e) {
                isDragging = true;
                sliderContainer.setPointerCapture(e.pointerId);
                updateSliderPosition(e.clientX);
            });

            sliderContainer.addEventListener('pointermove', function(e) {
                if (!isDragging) return;
                updateSliderPosition(e.clientX);
            });

            sliderContainer.addEventListener('pointerup', function(e) {
                isDragging = false;
                try { sliderContainer.releasePointerCapture(e.pointerId); } catch (err) {}
            });
        }

        function openImageModal(path, filename, date_display, category) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const meta = document.getElementById('modalMeta');
            modalImg.src = `/images/${path}`;
            meta.innerHTML = `<div><strong>${filename || ''}</strong></div><div>${date_display || ''}</div><div>${category || ''}</div>`;
            modal.style.display = 'flex';
            document.addEventListener('keydown', _imageModalKeyHandler);
        }
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = '';
            modal.style.display = 'none';
            document.removeEventListener('keydown', _imageModalKeyHandler);
        }
        function _imageModalKeyHandler(e) {
            if (e.key === 'Escape') closeImageModal();
        }

        function loadSelectedFromSession() {
            const sel = sessionStorage.getItem('selectedImage');
            if (!sel) { alert('Ei valittua kuvaa istunnossa'); return; }
            fetch('/api/image_by_path?path=' + encodeURIComponent(sel)).then(r=>r.json()).then(img=>{
                if (img && img.path) {
                    beforeImages = [img];
                    populateImageGrid('beforeGrid', beforeImages, 'before');
                    currentBeforeIndex = 0;
                    updateBeforeDisplay();
                    alert('Istunnosta ladattu kuva vanhemmaksi kuvaksi. Valitse toinen kuva vertailuun.');
                } else {
                    alert('Kuvaa ei l√∂ydy palvelimelta');
                }
            }).catch(err => { console.error(err); alert('Virhe haettaessa kuvaa'); });
        }

        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
            populateCompareCameras();
        });

        function setDefaultDates() {
            const today = new Date();
            const yesterday = new Date(today.getTime() - 24*60*60*1000);
            
            document.getElementById('beforeStart').value = formatDateTimeLocal(yesterday);
            document.getElementById('beforeEnd').value = formatDateTimeLocal(yesterday);
            document.getElementById('afterStart').value = formatDateTimeLocal(today);
            document.getElementById('afterEnd').value = formatDateTimeLocal(today);
        }
    </script>
</body>
</html>
    